{% extends 'base.html' %}
{% load static %}
{% load status_tags %}
{% block title %}Anuidades do Associado{% endblock title%}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
        <link rel="stylesheet" href="{% static 'css/associado.css' %}">
    <link rel="stylesheet" href="{% static 'css/listas.css' %}">
    <link rel="stylesheet" href="{% static 'css/anuidades_associado.css' %}">
    <link rel="stylesheet" href="{% static 'css/mensagens.css' %}">

{% endblock %}

{% block content %}
{% include 'components/navbar_superuser.html' %}


<div class="anuidades-container">
    <h1>Anuidades do Associado: {{ associado.user.get_full_name }}</h1>

    <div id="toast-container">
        {% for message in messages %}
            {% with message.tags as tag %}
                <div class="toast 
                    {% if 'success' in tag %}toast-success{% elif 'error' in tag or 'danger' in tag %}toast-error
                    {% elif 'info' in tag %}toast-info
                    {% elif 'warning' in tag %}toast-warning
                    {% else %}toast-info{% endif %}">
                    <span>{{ message }}</span>
                    <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                </div>
            {% endwith %}
        {% endfor %}
    </div>

    <div class="associado-header">
        <div class="associado-info">
            <a href="{% url 'app_associados:single_associado' associado.pk %}" class="link-associado">{{associado.user.get_full_name}}</a>
            <div class="dados-associado">
                <span><strong>Associa√ß√£o:</strong> {{ associado.associacao.nome_fantasia }}</span>
                <span><strong>Reparti√ß√£o:</strong> {{ associado.reparticao.nome_reparticao }}</span>
                <span><strong>Celular:</strong> {{ associado.celular }}</span>
                <span><strong>Filia√ß√£o:</strong> {{ associado.data_filiacao }}</span>
                <span>
                <p>
                    <strong>Status:</strong>
                    <span class="status-badge {{ associado.status|status_badge_class }}">
                        {{ associado.get_status_display }}
                    </span>
                </p>
                </span>
            </div>
        </div>

        <div class="anuidades-totais">
            <span><strong>Total Pago:</strong> R$ {{ total_pago_geral|floatformat:2 }}</span>
            <span><strong>Total Descontado:</strong> R$ {{ total_descontos_geral|floatformat:2 }}</span>
            <span><strong>Saldo Devedor:</strong> R$ {{ saldo_devedor_geral|floatformat:2 }}</span>
        </div>
    </div>

    {% for info in anuidade_infos %}
        <div class="anuidade-detalhes">        
            <table class="table-list">
                <thead>
                    <tr>
                        <th>Ano</th>
                        <th>Valor</th>
                        <th>Descontos</th>
                        <th>Total Pago</th>
                        <th>Saldo Devedor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ info.aa.anuidade.ano }}</td>
                        <td>R$ {{ info.valor_anuidade|floatformat:2 }}</td>
                        <td>R$ {{ info.total_descontos|floatformat:2 }}</td>
                        <td>R$ {{ info.total_pago|floatformat:2 }}</td>
                        <td>R$ {{ info.saldo_devedor|floatformat:2 }}</td>
                        <td>{{ info.status_anuidade }}</td>
                    </tr>
                </tbody>
            </table>

            <div style="flex: 1 1 45%;">
                <ul>
                    {% for p in info.pagamentos %}
                    <li class="pagamento-item">
                        <div class="pagamento-info">
                        {{ p.data_pagamento|date:"d/m/Y" }}: R$ {{ p.valor|floatformat:2 }}
                        {% if p.comprovante_up %}
                            (<a href="{{ p.comprovante_up.url }}" target="_blank" rel="noopener">Comprovante</a>)
                        {% endif %}
                        </div>

                        <div class="pagamento-meta">
                        <span class="registrado-por">
                            Registrado por:
                            {% if p.registrado_por %}
                            {{ p.registrado_por.get_full_name|default:p.registrado_por.username }}
                            {% else %}
                            ‚Äî
                            {% endif %}
                        </span>

                        {# Gerar recibo PARCIAL para este pagamento espec√≠fico #}
                        <a href="{% url 'app_automacoes:gerar_recibo_parcial_anuidade' info.aa.id %}?pagamento_id={{ p.id }}"
                            class="btn-recibo inline-block bg-amber-500 text-white py-1 px-3 rounded hover:bg-amber-600 text-sm transition"
                            target="_blank" rel="noopener"
                            title="Gerar recibo parcial para o pagamento de {{ p.data_pagamento|date:'d/m/Y' }}">
                            üßæ Gerar Recibo
                        </a>
                        </div>
                    </li>
                    <hr>
                    {% empty %}
                    <li>Nenhum pagamento registrado.</li>
                    {% endfor %}
                </ul>
                
                <h3>Pagamentos: {{ info.aa.anuidade.ano }}</h3>
            
                {% if info.status_anuidade == "PAGA" %}
                    <div style="margin-top:20px; text-align:center;">
                    <a href="{% url 'app_automacoes:gerar_recibo_anuidade' info.aa.id %}"
                    class="btn-recibo">
                    ‚úÖ Gerar Recibo de Quita√ß√£o Anuidade
                    </a>

                        <br>
                        <span style="font-size: 0.95em; color: #008000;">Anuidade quitada!</span>
                    </div>
                {% endif %}   

                {% if info.status_anuidade != "PAGA" %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="anuidade_id" value="{{ info.aa.pk }}">
                        <div class="form-container">
                            <div class="form-group">
                                {{ info.pagamento_form.as_p }} 
                            </div>
                        </div>
                        <button type="submit" name="pagar">Lan√ßar Pagamento</button>
                    </form>
                {% endif %}
            </div>

            <!-- BLOCO DE DESCONTOS -->
            <div style="flex: 1 1 45%;">
                <h3>Descontos: {{ info.aa.anuidade.ano }}</h3>
                <ul>
                    {% for d in info.descontos %}
                        <li>{{ d.data_concessao }}: R$ {{ d.valor_desconto|floatformat:2 }} ({{ d.motivo }})</li>
                    {% empty %}
                        <li>Nenhum desconto registrado.</li>
                    {% endfor %}
                </ul>              

                {% if info.status_anuidade != "PAGA" %}
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="anuidade_id" value="{{ info.aa.pk }}">
                        <div class="form-container">
                            <div class="form-group">
                                {{ info.desconto_form.as_p }}
                            </div>
                        </div>
                        <button type="submit" name="descontar">Lan√ßar Desconto</button>
                    </form>
                {% endif %}
            </div>
        </div>
    {% endfor %}
</div>

{% endblock %}