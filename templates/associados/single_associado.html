{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load status_tags %}

{% block title %}{{ associado.user.get_full_name }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/associado.css' %}">
    <link rel="stylesheet" href="{% static 'css/mensagens.css' %}">
    <link rel="stylesheet" href="{% static 'css/tabs.css' %}">
    <link rel="stylesheet" href="{% static 'css/associado_uploads.css' %}">
    <link rel="stylesheet" href="{% static 'css/listas.css' %}">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive_patch.css' %}">    
{% endblock %}

{% block content %}
    {% if request.user.is_superuser %}
        {% include "components/navbar_superuser.html" %}
    {% elif request.user.user_type == "admin_associacao" %}
        {% include "components/navbar_admin_associacao.html" %}
    {% elif request.user.user_type == "auxiliar_associacao" %}
        {% include "components/navbar_aux_associacao.html" %}
    {% else %}    
        {% include "components/navbar_home.html" %}
    {% endif %}

    <div class="detail-page">

        <div id="toast-container">
            {% for message in messages %}
                {% with message.tags as tag %}
                    <div class="toast 
                        {% if 'success' in tag %}toast-success{% elif 'error' in tag or 'danger' in tag %}toast-error
                        {% elif 'info' in tag %}toast-info
                        {% elif 'warning' in tag %}toast-warning
                        {% else %}toast-info{% endif %}">
                        <span>{{ message }}</span>
                        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>

    <header class="detail-header">     
        <div class="photo-name">
        {% if associado.foto %}
            <img src="{{ associado.foto.url }}" alt="Foto de {{ associado.user.get_full_name }}" class="assoc-photo">
        {% else %}
            <img src="{% static 'img/foto-fake.png' %}" alt="Foto gen√©rica do associado" class="assoc-photo">
        {% endif %}

        <h1>{{associado.user.get_full_name}}</h1>
        </div>
        <div class="header-actions">
            {% if associado.status != "desassociado" %}
                <a href="{% url 'app_associados:edit_associado' associado.pk %}" title="Editar">
                    <span class="material-icons">edit</span>
                </a>
            {% endif %}
            <a href="{% url 'app_associados:list_associados' %}" title="Voltar √† Lista">
                <span class="material-icons">list</span>
            </a>
        </div>

    </header>
    <!--Tabs-->
    <div class="tabs">
        <button class="tab-link active" data-tab="principal">Principal</button>
        <button class="tab-link" data-tab="pessoais">Pessoais</button>
        <button class="tab-link" data-tab="documentos">CopyDoc</button>
        <button class="tab-link" data-tab="uploads">Uploads</button>    
        <button class="tab-link" data-tab="servicos">Servi√ßos</button>
        <button class="tab-link" data-tab="declaracoes">Declara√ß√µes</button>
        <button class="tab-link" data-tab="inss">INSS</button>
        <button class="tab-link" data-tab="defeso">Defeso</button>
        <button class="tab-link" data-tab="embarcacoes">Embarca√ß√µes</button>
        <button class="tab-link" data-tab="anotacoes">Anota√ß√µes</button>        
    </div>
    <!--V√≠nculos PRINCIPAL-->
    <div class="tab-content active" id="tab-principal">
        <div class="detail-section three-cols">

            <div>
                <h2>V√≠nculos</h2>
                <p><strong>Associa√ß√£o:</strong> {{associado.associacao.nome_fantasia}}</p>
                <p><strong>Reparti√ß√£o:</strong> {{associado.reparticao.nome_reparticao}}</p>
                <p><strong>Delegado:</strong> {{associado.reparticao.delegado}}</p>
                <p><strong>Circunscri√ß√£o / Atua√ß√£o:</strong> {{associado.municipio_circunscricao}}</p>
                <p><strong>Data Filia√ß√£o:</strong> {{ associado.data_filiacao|date:"d/m/Y" }}</p>

                <p>
                    <strong>Status:</strong>
                    <span class="status-badge {{ associado.status|status_badge_class }}">
                        {{ associado.get_status_display }}
                    </span>
                </p>
                {% if associado.status == 'associado' %}
                    <div class="alert alert-warning" style="
                        background-color: #fff3cd; 
                        color: #856404; 
                        border: 1px solid #ffeeba; 
                        padding: 12px; 
                        margin-top: 10px; 
                        border-radius: 6px;">
                        ‚ö†Ô∏è O usu√°rio <strong>{{ associado.user.get_full_name }}</strong> foi refiliado com sucesso.<br>
                        <strong>Importante:</strong> o status atual est√° definido como <code>"associado"</code>. 
                        Por favor, edite o status para refletir corretamente o v√≠nculo atual 
                        (Ex: "Associado Lista Aposentado", "Cliente Especial", etc).<br>
                        <a href="{% url 'app_associados:edit_associado' associado.id %}" 
                        class="btn btn-sm btn-outline-warning" 
                        style="margin-top: 10px;">
                        Editar status
                        </a>
                    </div>
                {% endif %}

            </div>
            
            <div>
                <h2>Aplica√ß√µes</h2>
                {% if status_ok %}
                    {% if deve_aplicar_anuidades %}
                        <form method="post" style="margin: 15px 0;">
                            {% csrf_token %}
                            <button type="submit" name="aplicar_anuidades" class="btn btn-primary">
                                Aplicar Anuidade(s) {{ anos_faltantes|join:", " }}
                            </button>
                        </form>
                    {% elif msg_anuidades_aplicadas %}
                        <div style="color:green; font-size:13px;">
                            Todas as anuidades j√° foram aplicadas a este associado!
                        </div>
                    {% endif %}
                {% else %}
                    <div style="color:gray; font-size:13px;">
                        <strong>Anuidade: </strong>Anuidades s√≥ podem ser aplicadas quando o status for v√°lido = Ativo/Aposentado.
                    </div>
                {% endif %}

                <!-- BLOCO PARA INSS -->
                {% if associado.recolhe_inss == 'Sim' %}
                    {% if inss_aplicado %}
                        <div style="color:green; font-size:13px;">
                            Todas as guias INSS j√° foram aplicadas a este associado!
                        </div>
                    {% else %}
                        <form method="post" style="margin: 15px 0;">
                            {% csrf_token %}
                            <button type="submit" name="aplicar_inss" class="btn btn-success">
                                Incluir guias INSS do ano vigente 
                            </button>
                        </form>
                    {% endif %}
                {% else %}
                    <div style="color:#888; font-size:13px;">
                        <strong>INSS: </strong>Associado com status marcado como n√£o recolhe INSS.
                    </div>
                {% endif %}


                <!-- BLOCO PARA SEGURO DEFESO -->
                {% if associado.recebe_seguro == 'Recebe' %}
                    {% if not beneficio_defeso_ultimo %}
                        <div style="color:orange; font-size:13px;">
                            N√£o h√° defeso lan√ßado para o Estado onde este associado est√° vinculado.
                        </div>
                    {% elif defeso_aplicado %}
                        <div style="color:green; font-size:13px;">
                            Seguro Defeso j√° foi aplicado para este associado!
                        </div>
                    {% else %}
                        <form method="post" style="margin: 15px 0;">
                            {% csrf_token %}
                            <button type="submit" name="aplicar_defeso" class="btn btn-info">
                                Incluir no √∫ltimo Seguro Defeso lan√ßado
                            </button>
                        </form>
                    {% endif %}
                {% else %}
                    <div style="color:#888; font-size:13px;">
                        <strong>Defeso: </strong>Associado com status n√£o eleg√≠vel para participar do Seguro Defeso.
                    </div>
                {% endif %}

                <!-- BLOCO PARA REAP -->
                {% if reap_disponivel %}
                {% if reap_aplicado %}
                    <div style="color:green; font-size:13px;">
                    O REAP {{ reap_ano }}/{{ reap_rodada }} aplicado para este associado!
                    </div>
                {% else %}
                    {% if status_ok_reap %}

                    <form method="post" style="margin: 15px 0;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="aplicar_reap">
                        <button type="submit" class="btn btn-info">
                        Incluir no REAP atual
                        </button>
                    </form>
                    {% else %}
                    <div style="color:#888; font-size:13px;">
                        Este associado n√£o √© eleg√≠vel para participar do REAP (status atual: <strong>{{ associado.get_status_display }}</strong>).
                    </div>
                    {% endif %}
                {% endif %}
                {% else %}
                <div style="color:#888; font-size:13px;">
                    <strong>REAP:</strong> Ainda n√£o existem lan√ßamentos REAP dispon√≠veis no sistema.
                </div>
                {% endif %}
          
                <div>
                    <h4>Documentos p/ Apapesc</h4>
                    <small>Autodeclara√ß√£o; Acesso Gov; Imagem, Veracidade e Req. Filia√ß√£o </small>
                    {% for cod, status in docs_obrigatorios.items %}
                        <span class="doc-circle {% if status %}doc-ok{% else %}doc-bad{% endif %}">
                            {{ cod }}
                        </span>
                    {% endfor %}
                    
                </div>
            </div>  

            <div>
                <h2>Financeiro</h2>
                <a href="{% url 'app_anuidades:anuidade_associado_singular' associado.pk %}" class="upload-link">
                    üìÖ Ver anuidades e baixar/descontar
                </a>

                <div class="mini-tabela-anuidades">
                    <small>√öltimas Anuidades</small>
                    <table>
                        <thead>
                            <tr>
                                <th>Ano</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in ultimas_anuidades %}
                            <tr>
                                <td>{{ item.ano }}</td>
                                <td>
                                <span class="status-tag {% if item.status_pagamento == 'Paga' %}status-pago{% else %}status-pendente{% endif %}">
                                    {{ item.status_pagamento }}
                                </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="2">Sem dados dispon√≠veis.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>               
            <div>
                <h2>Contato</h2>
                <div class="copy-wrapper">
                    <p id="celular-correspondencia-{{ associado.pk }}"><strong>Celular:</strong> {{ associado.celular_correspondencia }}</p>
                    <button onclick="copyToClipboard('celular-correspondencia-{{ associado.pk }}', this)" class="copy-btn" title="Copiar Celular">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>
                <div class="copy-wrapper">
                    <p id="email-{{ associado.pk }}"><strong>Email:</strong> {{ associado.email }}</p>
                    <button onclick="copyToClipboard('email-{{ associado.pk }}', this)" class="copy-btn" title="Copiar Email">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>

                <div class="copy-wrapper">
                    <p id="senha-site-{{ associado.pk }}"><strong>Senha Site:</strong> {{ associado.senha_site }}</p>
                    <button onclick="copySenhas('senha-site-{{ associado.pk }}', this)" class="copy-btn" title="Copiar Senha Site">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>

                <div class="copy-wrapper">
                    <p id="senha-google-{{ associado.pk }}"><strong>Senha Google:</strong> {{ associado.senha_google }}</p>
                    <button onclick="copySenhas('senha-google-{{ associado.pk }}', this)" class="copy-btn" title="Copiar Senha Google">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>
            </div> 
            <div>
                <h2>Endere√ßo Residencial</h2>
                <p><strong>Logradouro:</strong> {{associado.logradouro}},
                    {{associado.numero}}, {{associado.complemento}}, {{associado.bairro}}</p>
                <p><strong>Municipio</strong> {{associado.municipio}}</p>
                <p><strong>UF</strong> {{associado.uf}}</p>
                <p><strong>CEP</strong> {{associado.cep}}</p>
            </div>  
            <div>
                <h2>Acesso</h2>
                <div class="copy-wrapper">
                    üóÇÔ∏è<p id="cpf-{{ associado.pk }}" style="color:red;"><strong>CPF:</strong> {{ associado.cpf }}</p>
                    <button onclick="copyToClipboard('cpf-{{ associado.pk }}', this)" class="copy-btn" title="Copiar CPF">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>
                <div class="copy-wrapper">
                    ‚ö†Ô∏è <p id="senha_gov-{{ associado.pk }}" style="color:red;"><strong>Senha Gov:</strong> {{ associado.senha_gov }}</p>
                    <button onclick="copySenhas('senha_gov-{{ associado.pk }}', this)" class="copy-btn" title="Copiar Senha Gov">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>

                <br><hr>
                {% if associado.drive_folder_id %}
                    <div class="drive-link">
                        <a href="https://drive.google.com/drive/folders/{{ associado.drive_folder_id }}" target="_blank">
                            <img src="https://www.gstatic.com/images/branding/product/2x/drive_2020q4_48dp.png"
                                alt="Google Drive" class="drive-icon"> 
                            <span> Acessar Pasta no Drive</span>
                        </a>
                        </div>
                        {% else %}
                        <div class="drive-link no-folder">
                        <span>Nenhuma pasta no Drive vinculada.</span>
                    </div>
                {% endif %}
            </div>
         
        </div>
    </div>

    <!--Dados Pessoais PESSOAIS-->
    <div class="tab-content" id="tab-pessoais">
        <div class="detail-section multi-cols">
            <h2>Dados Pessoais</h2>
            {% include "components/associados/dados_pessoais.html" %}
        </div><br><hr>

        <!-- Produ√ß√£o Anual -->
        <div class="detail-section full-width">
            <h2>Produ√ß√£o Anual de Pesca</h2>
            <table class="tabela-producao">
                <thead>
                <tr>
                    <th>Esp√©cie</th>
                    <th>Quantidade (Kg)</th>
                    <th>Pre√ßo por Kg (R$)</th>
                </tr>
                </thead>
                <tbody>
                {% if associado.especie1 %}
                <tr>
                    <td>{{ associado.especie1 }}</td>
                    <td>{{ associado.quantidade1 }}</td>
                    <td>{{ associado.preco1|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie2 %}
                <tr>
                    <td>{{ associado.especie2 }}</td>
                    <td>{{ associado.quantidade2 }}</td>
                    <td>{{ associado.preco2|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie3 %}
                <tr>
                    <td>{{ associado.especie3 }}</td>
                    <td>{{ associado.quantidade3 }}</td>
                    <td>{{ associado.preco3|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie4 %}
                <tr>
                    <td>{{ associado.especie4 }}</td>
                    <td>{{ associado.quantidade4 }}</td>
                    <td>{{ associado.preco4|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie5 %}
                <tr>
                    <td>{{ associado.especie5 }}</td>
                    <td>{{ associado.quantidade5 }}</td>
                    <td>{{ associado.preco5|floatformat:2 }}</td>
                </tr>
                {% endif %}
                </tbody>
            </table>
        </div><br><hr>
        <!-- Petrechos de Pesca -->
        <div class="detail-section four-cols">
            <h2 style="grid-column: 1 / -1;">Petrechos de Pesca</h2>
            {% for petrecho in associado.petrechos_pesca.all %}
                <div class="petrecho-box">{{ petrecho.nome }}</div>
            {% empty %}
                <p style="grid-column: 1 / -1;">Nenhum petrecho informado.</p>
            {% endfor %}
        </div>
    </div>

    <!--Documentos DOCUMENTOS COPY-->
    <div class="tab-content" id="tab-documentos">
        {% include "components/associados/copys.html" %}
    </div>

    <!--Uploads-->
    <div class="tab-content" id="tab-uploads">
        <div class="upload-links-row">
            <a href="{% url 'app_uploads:create_upload' %}?type=associado&id={{ associado.id }}" class="upload-link">
                üì§ Enviar Documento
            </a> 
             -- <a href="{% url 'app_uploads:create_tipo_doc' %}" class="upload-link">
                üìù Cadastrar Tipo de Documento
            </a>
             -- <a href="{% url 'app_uploads:list_tipo_docs' %}" class="upload-link">
                üìä Lista Tipos de Documentos
            </a>
            


        </div>

        <div class="detail-section full-width">
            <h2>Uploads</h2>

            {% if uploads_docs %}
                <div class="lista-container">
                    <table class="table-list-small">
                        <thead>
                        <tr>
                            <th>Tipo de Documento</th>
                            <th>Extens√£o</th>
                            <th>Data de Envio</th>
                            <th>Enviado Por</th>
                            <th>A√ß√µes</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for doc in uploads_docs %}
                            <tr>
                            <td>{{ doc.tipo.nome|default:doc.tipo_custom }}</td>
                            <!--Extens√£o-->
                            <td>{{ doc.arquivo.name|slice:"-4:"|upper }}</td>
                            <td>{{ doc.data_envio|date:"d/m/Y H:i" }}</td>
                            <td>{{ doc.enviado_por.get_full_name|default:doc.enviado_por.username }}</td>

                            <td>
                                <a href="{{ doc.arquivo.url }}" download title="Download">
                                    <span class="material-icons icon-download">download</span>
                                </a>

                                {% with doc.ext|lower as ext %}


                                    {% if ext|is_in:"jpg jpeg png" %}
                                        <a href="{% url 'app_uploads:converter_para_pdf' doc.pk %}" title="Converter imagem em PDF">
                                            <span class="material-icons icon-convert">picture_as_pdf</span>
                                        </a>
                                    {% endif %}

                                {% endwith %}

                                <a href="{{ doc.arquivo.url }}" target="_blank" title="Visualizar">
                                    <span class="material-icons icon-view">visibility</span>
                                </a>
                                {% if doc.proprietario_object.drive_folder_id %}
                                    <form method="post" action="{% url 'app_associados:enviar_para_drive' doc.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" title="Enviar para o Google Drive" style="background:none; border:none; padding:0; margin:0;">
                                            <span class="material-icons" style="color:rgb(128, 125, 250);">upload_file</span>
                                        </button>
                                    </form>
                                {% endif %}

                                <a href="#" class="btn-icon" title="Excluir Documento"
                                    onclick="openDeleteModal('{{ doc.pk }}')">
                                    <span class="material-icons icon-delete">delete</span>
                                </a>

                            </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
            <p>Nenhum documento enviado ainda.</p>
            {% endif %}
        </div> 
    </div>

    <!--Servi√ßos SERVICOS-->
    <div class="tab-content" id="tab-servicos">

        <a href="{% url 'app_servicos:create_servico' associado.pk %}?type=associado&id={{ associado.id }}" class="upload-link">
            üõ†Ô∏è  Novo Servi√ßo
        </a> 
             
       
        <div class="detail-section full-width">
            <h2>Servi√ßos</h2>
            {% if servicos %}
                <div class="lista-container">
                    <table class="table-list-small">
                        <thead>
                            <tr>
                                <th>Natureza</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Valor</th>
                                <th>Criado em</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for servico in servicos %}
                            <tr>
                                <td>{{ servico.get_natureza_servico_display }}</td>
                                <td>{{ servico.get_tipo_servico_display }}</td>
                                <td>{{ servico.status_servico|title }}</td>
                                <td>R$ {{ servico.valor|floatformat:2 }}</td>
                                <td>{{ servico.data_inicio|date:'d/m/Y H:i' }}</td>
                                <td>
                                    <a href="{% url 'app_servicos:single_servico' servico.pk %}" title="Visualizar servi√ßo">
                                        <span class="material-icons icon-view">visibility</span>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
            {% else %}
                <p>Nenhum servi√ßo vinculado</p>
            {% endif %}

        </div>
    </div>
    
    <!--Declara√ß√µes DECLARA√á√îES-->
    <div class="tab-content" id="tab-declaracoes">
        <h2>Declara√ß√µes automatizadas</h2>
        <span>N√£o esque√ßa de conferir o documento, caso algum campo n√£o estiver preenchido, poder√° encontra a palavra None ou N√£o Informado/Declarado.</span>
        <div class="detail-section five-cols">  

            <div style="background-color:#F5F9FF;">
                <h2>Pacote Inicial de Filia√ß√£o</h2>
                <a href="{% url 'app_automacoes:gerar_pacote_documentos' associado.id %}"
                class="btn btn-danger mt-3">
                Gerar Pacote de Documentos
                </a>
            </div>                 
            <div>
                <h2>Declara√ß√£o de Filia√ß√£o Apapesc</h2>
                <a href="{% url 'app_automacoes:gerar_declaracao_filiado' associado.id %}">
                    Gerar Documento
                </a>
            </div>
            <div>
                <h2>Declara√ß√£o de Ativ. Pesqueira</h2>
                <a href="{% url 'app_automacoes:gerar_declaracao_atividade_pesqueira' associado.id %}">
                    Gerar Documento
                </a>
            </div>
            <div>
                <h2>Declara√ß√£o de Resid√™ncia</h2>
                <a href="{% url 'app_automacoes:gerar_declaracao_residencia' associado.id %}">
                    Gerar Documento
                </a>
            </div> 
            <div>
                <h2>Declara√ß√£o de Hiposufici√™ncia</h2>
                <a href="{% url 'app_automacoes:gerar_declaracao_hipo' associado.id %}">
                    Gerar Documento
                </a>
            </div>   
            <div>
                <h2>Declara√ß√£o de Veracidade</h2>
                <a href="{% url 'app_automacoes:gerar_declaracao_veracidade' associado.id %}">
                    Gerar Documento
                </a>
            </div>            
            <div>
                <h2>Procura√ß√£o Jur√≠dica (Ad Judicia)</h2>
                <a href="{% url 'app_automacoes:gerar_procuracao_juridica' associado.id %}">
                    Gerar Documento
                </a>
            </div> 
            <div>
                <h2>Procura√ß√£o Administrativa</h2>
                <a href="{% url 'app_automacoes:gerar_procuracao_administrativa' associado.id %}">
                    Gerar Documento
                </a>
            </div> 
            <div>
                <h2>Autoriza√ß√£o Direito e uso de Imagem</h2>
                <a href="{% url 'app_automacoes:gerar_autorizacao_direitos_imagem' associado.id %}">
                    Gerar Documento
                </a>
            </div> 
            <div>
                <h2>Autoriza√ß√£o Acesso Conta Gov</h2>
                <a href="{% url 'app_automacoes:gerar_autorizacao_acesso_gov' associado.id %}">
                    Gerar Documento
                </a>
            </div> 
            <div>
                <h2>Regramentos Apapesc Direitos e Deveres</h2>
                <a href="{% url 'app_automacoes:gerar_direitos_deveres' associado.id %}">
                    Gerar Documento
                </a>
            </div> 
            <div>
                <h2>Registro de Retirada de Documentos</h2>
                <a href="{% url 'app_automacoes:gerar_retirada_documentos' associado.id %}">
                    Gerar Documento
                </a>
            </div> 
            <div>
                <h2>Declara√ß√£o Desfilia√ß√£o Apapesc</h2>
                <a href="{% url 'app_automacoes:gerar_declaracao_desfiliacao' associado.id %}">
                    Gerar Documento
                </a>
            </div> 
            <div>
                <h2>Carteirinha Associado Apapesc</h2>
                <a href="{% url 'app_automacoes:gerar_carteirinha_apapesc' associado.id %}">
                    Gerar Documento
                </a>
            </div>  
            <div>
                <h2>Requerimento Filia√ß√£o Apapesc</h2>
                <a href="{% url 'app_automacoes:gerar_requerimento_filiacao' associado.id %}">
                    Gerar Documento
                </a>
            </div>                                                                                                                                                                                                                      
        </div>
    </div>    

  

    <!--Produ√ß√£o INSS-->
    <div class="tab-content" id="tab-inss">
        <h2>Guias INSS</h2>
        <table class="table-list-small">
            <thead>
                <tr>
                    <th>M√™s/Ano</th>
                    <th>Status Emiss√£o</th>
                    <th>Status Acesso</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                {% for guia in guias_inss %}
                    <tr>
                        <form method="post" style="display: contents;">
                            {% csrf_token %}
                            <input type="hidden" name="guia_id" value="{{ guia.id }}">
                            <td>{{ guia.get_mes_display }}/{{ guia.ano }}</td>
                            <td>
                                <div style="display: flex; gap: 6px; background: #f2faff; border-radius: 4px; padding: 4px 8px;">
                                {% for value, label in STATUS_EMISSAO_INSS %}
                                    <label style="font-size: 11px; margin: 0 3px 0 0;">
                                        <input type="radio" name="status_emissao" value="{{ value }}" {% if guia.status_emissao == value %}checked{% endif %}>
                                        {{ label }}
                                    </label>
                                {% endfor %}
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; gap: 6px; background: #f6f6f9; border-radius: 4px; padding: 4px 8px;">
                                {% for value, label in ACESSO_CHOICES %}
                                    <label style="font-size: 11px; margin: 0 3px 0 0;">
                                        <input type="radio" name="status_acesso" value="{{ value }}" {% if guia.status_acesso == value %}checked{% endif %}>
                                        {{ label }}
                                    </label>
                                {% endfor %}
                                </div>
                            </td>
                            <td>
                                <button type="submit" onclick="saveTabHash(this)">Salvar</button>

                            </td>
                        </form>
                    </tr>
                {% empty %}
                    <tr><td colspan="4">Nenhuma guia encontrada.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!--Produ√ß√£o Defeso-->
    <div class="tab-content" id="tab-defeso">

        {% if not beneficio_defeso_ultimo %}
            <p style="color:#888;">
                N√£o h√° benef√≠cio de Seguro Defeso lan√ßado para o estado deste associado.
            </p>
        {% else %}

        <div class="form-grid grid-3-cols">
            <!-- ‚Äì DADOS GOV -->
            <div class="defeso-gov">
                <div class="copy-row">
                    <span class="icon">üóÇÔ∏è</span>
                    <span id="cpf-{{ associado.pk }}" style="color:#f48585;">
                        <strong>CPF:</strong> {{ associado.cpf }}
                    </span>
                    <button onclick="copyToClipboard('cpf-{{ associado.pk }}', this)"
                            class="copy-btn" title="Copiar CPF">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>

                <div class="copy-row warning">
                    <span class="icon">‚ö†Ô∏è</span>
                    <span id="senha_gov-{{ associado.pk }}" style="color:#f48585;">
                        <strong>Senha Gov:</strong> {{ associado.senha_gov }}
                    </span>
                    <button onclick="copySenhas('senha_gov-{{ associado.pk }}', this)"
                            class="copy-btn" title="Copiar Senha Gov">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>

                <div class="copy-row email">
                    <span class="icon">üì¨</span>
                    <span id="doc_email-{{ associado.pk }}" style="color:purple;">
                        apaescpescadores@gmail.com
                    </span>
                    <button onclick="copySenhas('doc_email-{{ associado.pk }}', this)"
                            class="copy-btn" title="Copiar Email">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>
            </div>
            <!-- ‚Äì BENEF√çCIO -->
            <div class="defeso-beneficio">
                <small>
                    <strong>Benef√≠cio:</strong>
                    {{ beneficio_defeso_ultimo.lei_federal }}<br>
                    <strong>Esp√©cie:</strong> {{ beneficio_defeso_ultimo.especie_alvo }}<br>
                    <strong>Per√≠odo:</strong>
                    {{ beneficio_defeso_ultimo.data_inicio|date:"d/m/Y" }}
                    ‚Üí
                    {{ beneficio_defeso_ultimo.data_fim|date:"d/m/Y" }}
                </small>
            </div>

            {% if inss_resumo %}
            <div class="card inss-card">
                <div class="inss-head">
                <div>

                    <div class="inss-sub">INSS - {{ inss_ano }}</div>
                </div>

                <div class="inss-count {% if inss_qtd_paga < 8 %}bad{% else %}ok{% endif %}">
                    {{ inss_qtd_paga }}/8
                </div>
                </div>

                <div class="inss-bar">
                <div class="inss-fill {% if inss_qtd_paga < 8 %}bad{% else %}ok{% endif %}"
                    style="width: {{ inss_percent }}%;"></div>
                </div>

                {% if inss_qtd_paga < 8 %}
                <div class="inss-pendentes">
                    Pendentes: {{ inss_pendentes|join:", " }}
                </div>
                {% else %}
                <div class="inss-ok">Em dia ‚úÖ</div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <div class="form-grid grid-1-cols">
            <div class="card">
                <table class="table-list-small">
                    <thead>
                    <tr>
                        <th>Ano</th>
                        <th>Reap</th>
                        <th>Atualizado</th>
                        <th>Editar</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for reap in reap_ultimos_2 %}
                        <tr>
                        <td>{{ reap.ano }}</td>
                        <td>
                            <span class="status-tag status-reap-{{ reap.status_resposta|lower }}">
                            {{ reap.get_status_resposta_display }}
                            </span>
                        </td>
                        <td>{{ reap.atualizado_em }}</td>
                        <td>
                            <a href="{% url 'app_reap:processamento_reap_individual' reap.pk %}"
                            target="_blank"
                            title="Editar REAP {{ reap.ano }}"
                            class="btn-icon-link">
                                ‚úèÔ∏è
                            </a>
                        </td>                            
                        </tr>
                    {% empty %}
                        <tr><td colspan="4">Nenhum REAP encontrado para este associado.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

            {% if not defeso_status_elegivel %}
            <div class="alert alert-warning" style="background:#fff7ed;border:1px solid #fdba74;color:#c2410c;padding:8px;border-radius:6px;">
                Este associado n√£o √© eleg√≠vel para opera√ß√µes de Seguro Defeso (status atual n√£o permite).
            </div>
            {% else %}

              
            <form method="post" enctype="multipart/form-data" style="margin-top:12px;">
                {% csrf_token %}
                
                {% if defeso_form %}
                <div class="form-grid grid-5-cols">
                    <div class="form-group">
                        {{ defeso_form.dar_entrada.label_tag }}
                        {{ defeso_form.dar_entrada }}<small>Selecione o m√™s de entrada</small>
                    </div>  

                    <div class="form-group">
                    {{ defeso_form.status_pedido.label_tag }}
                    {{ defeso_form.status_pedido }}<small>Status/Movimenta√ß√£o</small>
                    {{ defeso_form.status_pedido.errors }}
                    </div>

                    <div class="form-group">
                    {{ defeso_form.numero_protocolo.label_tag }}
                    {{ defeso_form.numero_protocolo }}<small>ou / n√∫mero do requerimento</small>
                    {{ defeso_form.numero_protocolo.errors }}
                    </div>



                    <div class="form-group">
                    {{ defeso_form.data_solicitacao.label_tag }}
                    {{ defeso_form.data_solicitacao }}
                    {{ defeso_form.data_solicitacao.errors }}
                    </div>

                    <div class="form-group">
                    {{ defeso_form.data_concessao.label_tag }}
                    {{ defeso_form.data_concessao }}
                    {{ defeso_form.data_concessao.errors }}
                    </div>

                    <div class="form-group" style="grid-column:1 / -1;">
                        {{ defeso_form.anotacoes.label_tag }}
                        {{ defeso_form.anotacoes }}
                        {{ defeso_form.anotacoes.errors }}
                    </div>

                    <style>
                    #id_anotacoes {
                        color: red !important;
                    }
                    </style>   


                    <div class="form-group" style="grid-column:1 / -1;">
                    {{ defeso_form.motivo_exigencia.label_tag }}
                    {{ defeso_form.motivo_exigencia }}
                    {{ defeso_form.motivo_exigencia.errors }}
                    </div>

                    <div class="form-group" style="grid-column:1 / -1;">
                    {{ defeso_form.motivo_negativa.label_tag }}
                    {{ defeso_form.motivo_negativa }}
                    {{ defeso_form.motivo_negativa.errors }}
                    </div>                


                    <div class="form-group" style="grid-column:1 / -1;">
                    {{ defeso_form.resultado_final.label_tag }}
                    {{ defeso_form.resultado_final }}
                    {{ defeso_form.resultado_final.errors }}
                    </div>

                    <div class="form-group" style="grid-column:1 / -1;">
                        <div class="uploaded-documents">
                            {% for doc in documentos_protocolo_up %}
                                <div class="doc-item">
                                    <a href="{{ doc.arquivo.url }}" target="_blank" class="doc-link">
                                        üìÑ {{ doc.tipo.nome|default:"Documento" }} ‚Äì Enviado em {{ doc.data_envio|date:"d/m/Y H:i" }}
                                    </a>
                                </div>
                            {% empty %}
                                <p class="doc-empty">Nenhum comprovante de protocolo do defeso enviado.</p>
                            {% endfor %}
                        </div>

                        <a href="{% url 'app_uploads:create_upload' %}?type=associado&id={{ associado.id }}&from=defeso_tab&beneficio={{ beneficio_defeso_ultimo.id }}"
                            class="btn-doc-upload">
                            ‚ö†Ô∏è Somente Enviar comprovante de protocolo do Seg. Defeso
                        </a>
                    </div>

                </div>

                <button type="submit" name="salvar_defeso" class="btn btn-primary" style="margin-top:8px;">
                    Salvar Seguro Defeso
                </button>
                {% else %}
                <p style="color:#888;">Formul√°rio indispon√≠vel neste momento.</p>
                {% endif %}
            </form>

            {% endif %}
        {% endif %}

    </div>

    <div class="tab-content" id="tab-embarcacoes">
        <div class="detail-section full-width">
            <h3>Embarca√ß√µes</h3>

            <a href="{% url 'app_embarcacoes:create_embarcacao' associado.id %}" class="btn btn-primary">
                + Adicionar Embarca√ß√£o
            </a>

            {% if embarcacoes %}
            <div class="lista-container">
                <table class="table-list-small">
                    <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Inscri√ß√£o</th>
                        <th>Tipo</th>
                        <th>Validade TIE</th>
                        <th>Ano de Constru√ß√£o</th>
                        <th>A√ß√µes</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for emb in embarcacoes %}
                        <tr>
                            <td>{{ emb.nome_embarcacao }}</td>
                            <td>{{ emb.inscricao_embarcacao }}</td>
                            <td>{{ emb.get_tipo_embarcacao_display }}</td>
                            <td>{{ emb.validade_tie|date:"d/m/Y" }}</td>
                            <td>{{ emb.ano_construcao }}</td>
                            <td>
                                <a href="{% url 'app_embarcacoes:single_embarcacao' emb.pk %}" title="Ver Detalhes">
                                    <span class="material-icons icon-view">visibility</span>
                                </a>
                                <a href="{% url 'app_embarcacoes:edit_embarcacao' emb.pk %}" title="Editar">
                                    <span class="material-icons icon-edit">edit</span>
                                </a>
                                <a href="#" class="btn-icon" title="Excluir Embarca√ß√£o"
                                onclick="openDeleteModal('{{ emb.pk }}')">
                                    <span class="material-icons icon-delete">delete</span>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>Nenhuma embarca√ß√£o cadastrada ainda.</p>
            {% endif %}
        </div>
    </div>
 

    <div class="tab-content" id="tab-anotacoes">
        <div class="detail-section full-width">
            <h3>Anota√ß√µes</h3>
            <form id="notas-form" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <textarea
                        name="content"
                        id="content-textarea"
                        rows="10"
                        style="width:100%; min-height:160px; resize:vertical; padding:10px; font-size:14px; font-family: inherit; background:white;"
                        oninput="autoGrow(this)"
                    >{{ associado.content|default_if_none:"" }}</textarea>


                </div>
                <button type="submit" id="btn-salvar-anotacao" class="btn btn-primary" style="margin-top:8px;">Salvar Anota√ß√µes</button>
                <span id="notas-msg" style="margin-left:15px;color:green;display:none;"></span>
            </form>
        </div>
    </div>

    <!--Modal -->
    <div id="deleteModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <h3>Excluir Documento?</h3>
            <p>Tem certeza que deseja remover este documento?</p>
            <div class="modal-actions">
            <button id="confirmDeleteBtn" class="btn btn-danger">Sim, excluir</button>
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    

{% block extra_js %}
    <script src="{% static 'js/tabs.js' %}"></script>
    <script src="{% static 'js/multiples_uploads.js' %}"></script>
    <script src="{% static 'js/openCamera.js' %}"></script>
    <script src="{% static 'js/delete_upload.js' %}"></script>
    <script src="{% static 'js/copy_to_clipboard.js' %}"></script>
    <script src="{% static 'js/copy_senhas.js' %}"></script>
    <script src="{% static 'js/content_associados.js' %}"></script>
    <script src="{% static 'js/config_content_associados.js' %}"></script>
    <script src="{% static 'js/dar_entrada.js' %}"></script>
    <script src="{% static 'js/cores_status_pedido_defeso.js' %}"></script>
{% endblock %}

{% endblock %}
