{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ associado.user.get_full_name }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/associado.css' %}">
    <link rel="stylesheet" href="{% static 'css/mensagens.css' %}">
    <link rel="stylesheet" href="{% static 'css/associado_tabs.css' %}">
    <link rel="stylesheet" href="{% static 'css/associado_uploads.css' %}">
    <link rel="stylesheet" href="{% static 'css/listas.css' %}">
{% endblock %}

{% block content %}
{% include 'components/navbar_superuser.html' %}

    <div class="detail-page">

        <div id="toast-container">
            {% for message in messages %}
                {% with message.tags as tag %}
                    <div class="toast 
                        {% if 'success' in tag %}toast-success{% elif 'error' in tag or 'danger' in tag %}toast-error
                        {% elif 'info' in tag %}toast-info
                        {% elif 'warning' in tag %}toast-warning
                        {% else %}toast-info{% endif %}">
                        <span>{{ message }}</span>
                        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>

    <header class="detail-header">     
        <div class="photo-name">
        {% if associado.foto %}
            <img src="{{ associado.foto.url }}" alt="Foto de {{ associado.user.get_full_name }}" class="assoc-photo">
        {% else %}
            <img src="{% static 'img/foto-fake.png' %}" alt="Foto genérica do associado" class="assoc-photo">
        {% endif %}

        <h1>{{associado.user.get_full_name}}</h1>
        </div>
        <div class="header-actions">
        <a href="{% url 'app_associados:edit_associado' associado.pk %}" title="Editar"><span class="material-icons">edit</span></a>
        <a href="{% url 'app_associados:list_associados' %}" title="Voltar à Lista"><span class="material-icons">list</span></a>
        </div>
    </header>
    <!--Tabs-->
    <div class="tabs">
        <button class="tab-link active" data-tab="principal">Principal</button>
        <button class="tab-link" data-tab="pessoais">Pessoais</button>
        <button class="tab-link" data-tab="documentos">Documentos</button>
        <button class="tab-link" data-tab="uploads">Uploads</button>
        <button class="tab-link" data-tab="servicos">Serviços</button>
        <button class="tab-link" data-tab="declaracoes">Declarações</button>
        <button class="tab-link" data-tab="financeiro">Financeiro</button>
        <button class="tab-link" data-tab="producao">Produção</button>
        <button class="tab-link" data-tab="anotacoes">Anotações</button>        
    </div>
    <!--Vínculos-->
    <div class="tab-content active" id="tab-principal">
        <div class="detail-section two-cols">
            <div>
                <h2>Vínculos</h2>
                <p><strong>Associação:</strong> {{associado.associacao.nome_fantasia}}</p>
                <p><strong>Repartição:</strong> {{associado.reparticao.nome_reparticao}}</p>
                <p><strong>Delegado:</strong> {{associado.reparticao.delegado}}</p>
                <p><strong>Circunscrição / Atuação:</strong> {{associado.municipio_circunscricao}}</p>
                <p><strong>Data Filiação:</strong> {{ associado.data_filiacao|date:"d/m/Y" }}</p>
            </div>
            <div>
                <h2>Acesso</h2>
                <p><strong>CPF:</strong> {{associado.cpf}}</p>
                <p><strong>Senha Gov: </strong> {{associado.senha_gov}}</p>
                <br><hr>
                {% if associado.drive_folder_id %}
                    <div class="drive-link">
                        <a href="https://drive.google.com/drive/folders/{{ associado.drive_folder_id }}" target="_blank">
                            <img src="https://www.gstatic.com/images/branding/product/2x/drive_2020q4_48dp.png"
                                alt="Google Drive" class="drive-icon"> 
                            <span> Acessar Pasta no Drive</span>
                        </a>
                        </div>
                        {% else %}
                        <div class="drive-link no-folder">
                        <span>Nenhuma pasta no Drive vinculada.</span>
                    </div>
                {% endif %}
            </div>
            <div>
                <h2>Contato</h2>
                <p><strong>Celular:</strong> {{associado.associacao.celular}}</p>
                <p><strong>Correspondência: </strong> {{associado.celular_correspondencia}}</p>
                <p><strong>Email</strong> {{associado.associacao.email}}</p>
                <p><strong>Senha Site: </strong> {{associado.senha_site}}</p>
                <p><strong>Senha Google: </strong> {{associado.senha_google}}</p>
            </div>            
            <div>
                <h2>Endereço Residencial</h2>
                <p><strong>Logradouro:</strong> {{associado.logradouro}},
                    {{associado.numero}}, {{associado.complemento}}, {{associado.bairro}}</p>
                <p><strong>Municipio</strong> {{associado.municipio}}</p>
                <p><strong>UF</strong> {{associado.uf}}</p>
                <p><strong>CEP</strong> {{associado.cep}}</p>
            </div>            
            <div>
                <h2>Aplicações</h2>
                <p><strong>Anuidade:</strong> Aplciada!</p>
                <p><strong>Seguro Defeso</strong> Não Aplicado</p>
                <p><strong>INSS</strong> Aplicado</p>
            </div>            
        </div>
    </div>
    <!--Dados Pessoais-->
    <div class="tab-content" id="tab-pessoais">
        <div class="detail-section multi-cols">
            <h2>Dados Pessoais</h2>
            <div class="field-grid">
                <div class="field-card"><p><strong>Sexo Biológico:</strong> {{ associado.sexo_biologico|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Etnia:</strong> {{ associado.etnia|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Escolaridade:</strong> {{ associado.escolaridade|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Estado Civil:</strong> {{ associado.estado_civil|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Profissão:</strong> {{ associado.profissao|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Recolhe INSS:</strong> {{ associado.recolhe_inss|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Recebe Seguro Defeso:</strong> {{ associado.recebe_seguro|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Já recebeu Defeso:</strong> {{ associado.ja_recebeu_defeso_algumavez|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Relação de Trabalho:</strong> {{ associado.relacao_trabalho|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Comercializa Produtos:</strong> {{ associado.comercializa_produtos|default:"—" }}</p></div>                
                <div class="field-card"><p><strong>Bolsa Família:</strong> {{ associado.bolsa_familia|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Casa onde Mora:</strong> {{ associado.casa_onde_mora|default:"—" }}</p></div>
                <div class="field-card"><p><strong>Outra Fonte de Renda:</strong> {{ associado.outra_fonte_renda|default:"—" }}</p></div>                
            </div>
        </div><br><hr>

        <!-- Produção Anual -->
        <div class="detail-section full-width">
            <h2>Produção Anual de Pesca</h2>
            <table class="tabela-producao">
                <thead>
                <tr>
                    <th>Espécie</th>
                    <th>Quantidade (Kg)</th>
                    <th>Preço por Kg (R$)</th>
                </tr>
                </thead>
                <tbody>
                {% if associado.especie1 %}
                <tr>
                    <td>{{ associado.especie1 }}</td>
                    <td>{{ associado.quantidade1 }}</td>
                    <td>{{ associado.preco1|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie2 %}
                <tr>
                    <td>{{ associado.especie2 }}</td>
                    <td>{{ associado.quantidade2 }}</td>
                    <td>{{ associado.preco2|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie3 %}
                <tr>
                    <td>{{ associado.especie3 }}</td>
                    <td>{{ associado.quantidade3 }}</td>
                    <td>{{ associado.preco3|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie4 %}
                <tr>
                    <td>{{ associado.especie4 }}</td>
                    <td>{{ associado.quantidade4 }}</td>
                    <td>{{ associado.preco4|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie5 %}
                <tr>
                    <td>{{ associado.especie5 }}</td>
                    <td>{{ associado.quantidade5 }}</td>
                    <td>{{ associado.preco5|floatformat:2 }}</td>
                </tr>
                {% endif %}
                </tbody>
            </table>
        </div><br><hr>
        <!-- Petrechos de Pesca -->
        <div class="detail-section four-cols">
        <h2 style="grid-column: 1 / -1;">Petrechos de Pesca</h2>
        {% for petrecho in associado.petrechos_pesca.all %}
            <div class="petrecho-box">{{ petrecho.nome }}</div>
        {% empty %}
            <p style="grid-column: 1 / -1;">Nenhum petrecho informado.</p>
        {% endfor %}
        </div>


    </div>
    <!--Documentos-->
    <div class="tab-content" id="tab-documentos">
        <div class="detail-section three-cols">
            <div>
                <h2>Identidade</h2>
                <p><strong>RG:</strong> {{ associado.rg_numero }}</p>
                <p><strong>Órgão Emissor:</strong> {{ associado.rg_orgao }}</p>
                <p><strong>Data Emissão:</strong> {{ associado.rg_data_emissao|date:"d/m/Y" }}</p>
                <p><strong>Data Nascimento:</strong> {{ associado.data_nascimento|date:"d/m/Y" }}</p>
                <p><strong>Naturalidade:</strong> {{ associado.naturalidade }}</p>
            </div>
            <div>
                <h2>Carteira Motorista</h2>
                <p><strong>N. Registro:</strong> {{ associado.cnh }}</p>
                <p><strong>Data Emissão:</strong> {{ associado.cnh_data_emissao|date:"d/m/Y" }}</p>
                <p><strong>Data Validade:</strong> {{ associado.cnh_data_validade|date:"d/m/Y" }}</p>
                <p><strong>UF:</strong> {{ associado.cnh_uf }}</p>
            </div>

            <div>
                <h2>Carteira de Pescador</h2>
                <p><strong>RGP:</strong> {{ associado.rgp }}</p>
                <p><strong>Órgão Emissor:</strong> {{ associado.rgp_mpa }}</p>                
                <p><strong>Data Emissão:</strong> {{ associado.rgp_data_emissao|date:"d/m/Y" }}</p>
                <p><strong>Primeiro Registro:</strong> {{ associado.primeiro_registro|date:"d/m/Y" }}</p>
            </div>
            <div>
                <h2>Carteira de Trabalho</h2>
                <p><strong>Número:</strong> {{ associado.ctps }}</p>
                <p><strong>Data Emissão:</strong> {{ associado.ctps_data_emissao|date:"d/m/Y" }}</p>
                <p><strong>Série:</strong> {{ associado.ctps_serie }}</p>
                <p><strong>UF:</strong> {{ associado.ctps_uf }}</p>
            </div>
            <div>
                <h2>Documentos Cidadania</h2>
                <p><strong>Título:</strong> {{ associado.titulo_eleitor }}</p>
                <p><strong>PIS:</strong> {{ associado.pis }}</p>
                <p><strong>NIT:</strong> {{ associado.nit }}</p>
                <p><strong>CAEPF:</strong> {{ associado.caepef }}</p>
                <p><strong>CEI:</strong> {{ associado.cei }}</p>
               
            </div>
            <div>
                <h2>Aguardando</h2>

            </div>                                                           
        </div>
    </div>
    <!--Uploads-->
    <div class="tab-content" id="tab-uploads">
        <div class="upload-links-row">
            <a href="{% url 'app_uploads:create_upload' %}?type=associado&id={{ associado.id }}" class="upload-link">
                📤 Enviar Documento
            </a> 
             -- <a href="{% url 'app_uploads:create_tipo_doc' %}" class="upload-link">
                📝 Cadastrar Tipo de Documento
            </a>
             -- <a href="{% url 'app_uploads:list_tipo_docs' %}" class="upload-link">
                Lista Tipos de Documentos
            </a>            
        </div>

        <div class="detail-section full-width">
            <h2>Uploads</h2>

            {% if uploads_docs %}
                <div class="lista-container">
                    <table class="table-list-small">
                        <thead>
                        <tr>
                            <th>Tipo de Documento</th>
                            <th>Extensão</th>
                            <th>Data de Envio</th>
                            <th>Enviado Por</th>
                            <th>Ações</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for doc in uploads_docs %}
                            <tr>
                            <td>{{ doc.tipo.nome|default:doc.tipo_custom }}</td>
                            <!--Extensão-->
                            <td>{{ doc.arquivo.name|slice:"-4:"|upper }}</td>
                            <td>{{ doc.data_envio|date:"d/m/Y H:i" }}</td>
                            <td>{{ doc.enviado_por.get_full_name|default:doc.enviado_por.username }}</td>

                            <td>
                                <a href="{{ doc.arquivo.url }}" download title="Download">
                                    <span class="material-icons icon-download">download</span>
                                </a>

                                {% with doc.ext|lower as ext %}


                                    {% if ext|is_in:"jpg jpeg png" %}
                                        <a href="{% url 'converter_para_pdf' doc.pk %}" title="Converter imagem em PDF">
                                            <span class="material-icons icon-convert">picture_as_pdf</span>
                                        </a>
                                    {% endif %}

                                    {% if ext != "pdf" %}
                                        <a href="{% url 'app_uploads:converter_para_pdf' doc.pk %}" title="Converter para PDF">
                                            <span class="material-icons icon-convert">picture_as_pdf</span>
                                        </a>
                                    {% endif %}
                                {% endwith %}

                                <a href="{{ doc.arquivo.url }}" target="_blank" title="Visualizar">
                                    <span class="material-icons icon-view">visibility</span>
                                </a>
                                {% if doc.proprietario_object.drive_folder_id %}
                                    <form method="post" action="{% url 'app_associados:enviar_para_drive' doc.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" title="Enviar para o Google Drive" style="background:none; border:none; padding:0; margin:0;">
                                            <span class="material-icons" style="color:rgb(128, 125, 250);">upload_file</span>
                                        </button>
                                    </form>
                                {% endif %}

                                <a href="#" class="btn-icon" title="Excluir Documento"
                                    onclick="openDeleteModal('{{ doc.pk }}')">
                                    <span class="material-icons icon-delete">delete</span>
                                </a>

                            </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Nenhum documento enviado ainda.</p>
            {% endif %}
            </div>
        <div>
    </div>    
    <!--Serviços-->
    <div class="tab-content" id="tab-servicos">
        <div class="detail-section full-width">
        <h2>Serviços</h2>
        <p>Emissão Documento: 12</p>
        <p>Marinha: 5</p>
        <p>Licença: 40 horas</p>
        </div>
    </div>
    <!--Declarações-->
    <div class="tab-content" id="tab-declaracoes">
        <div class="detail-section full-width">
        <h2>Declarações - Automatizadas</h2>
        <p>Dec: 12</p>
        <p>Dec: 5</p>
        <p>Dec: 40 horas</p>
        </div>
    </div>    
    <!--Financeiro-->
    <div class="tab-content" id="tab-financeiro">
        <div class="detail-section two-cols">
        <div>
            <h2>Financeiro</h2>
            <p><strong>Dados:</strong> Up - 20/06/2005</p>
        </div>
        <div>
            <h2>Painel</h2>
            <p><strong>Números:</strong> A9R8765</p>
        </div>
        </div>
    </div>     
    <!--Produção Anual-->
    <div class="tab-content" id="tab-producao">
        <div class="detail-section full-width">
        <h2>Produção Anual</h2>
        <p>Artigos publicados em 2024: 12</p>
        <p>Participação em eventos: 5</p>
        <p>Voluntariado: 40 horas</p>
        </div>
    </div>
    <div class="tab-content" id="tab-anotacoes">
        <div class="detail-section full-width">
        <h2>Anotações</h2>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque in arcu vitae arcu tincidunt venenatis.</p>
        </div>
    </div>
    </div>

    <div id="deleteModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <h3>Excluir Documento?</h3>
            <p>Tem certeza que deseja remover este documento?</p>
            <div class="modal-actions">
            <button id="confirmDeleteBtn" class="btn btn-danger">Sim, excluir</button>
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    

{% block extra_js %}
<script src="{% static 'js/tabs.js' %}"></script>
<script src="{% static 'js/multiples_uploads.js' %}"></script>
<script src="{% static 'js/delete_upload.js' %}"></script>
{% endblock %}

{% endblock %}
