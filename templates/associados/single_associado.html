{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ associado.user.get_full_name }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/associado.css' %}">
    <link rel="stylesheet" href="{% static 'css/mensagens.css' %}">
    <link rel="stylesheet" href="{% static 'css/tabs.css' %}">
    <link rel="stylesheet" href="{% static 'css/associado_uploads.css' %}">
    <link rel="stylesheet" href="{% static 'css/listas.css' %}">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}
{% include 'components/navbar_superuser.html' %}

    <div class="detail-page">

        <div id="toast-container">
            {% for message in messages %}
                {% with message.tags as tag %}
                    <div class="toast 
                        {% if 'success' in tag %}toast-success{% elif 'error' in tag or 'danger' in tag %}toast-error
                        {% elif 'info' in tag %}toast-info
                        {% elif 'warning' in tag %}toast-warning
                        {% else %}toast-info{% endif %}">
                        <span>{{ message }}</span>
                        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>

    <header class="detail-header">     
        <div class="photo-name">
        {% if associado.foto %}
            <img src="{{ associado.foto.url }}" alt="Foto de {{ associado.user.get_full_name }}" class="assoc-photo">
        {% else %}
            <img src="{% static 'img/foto-fake.png' %}" alt="Foto gen√©rica do associado" class="assoc-photo">
        {% endif %}

        <h1>{{associado.user.get_full_name}}</h1>
        </div>
        <div class="header-actions">
        <a href="{% url 'app_associados:edit_associado' associado.pk %}" title="Editar"><span class="material-icons">edit</span></a>
        <a href="{% url 'app_associados:list_associados' %}" title="Voltar √† Lista"><span class="material-icons">list</span></a>
        </div>
    </header>
    <!--Tabs-->
    <div class="tabs">
        <button class="tab-link active" data-tab="principal">Principal</button>
        <button class="tab-link" data-tab="pessoais">Pessoais</button>
        <button class="tab-link" data-tab="documentos">Documentos</button>
        <button class="tab-link" data-tab="uploads">Uploads</button>    
        <button class="tab-link" data-tab="servicos">Servi√ßos</button>
        <button class="tab-link" data-tab="declaracoes">Declara√ß√µes</button>
        <button class="tab-link" data-tab="producao">Produ√ß√£o</button>
        <button class="tab-link" data-tab="anotacoes">Anota√ß√µes</button>        
    </div>
    <!--V√≠nculos-->
    <div class="tab-content active" id="tab-principal">
        <div class="detail-section three-cols">
            <div>
                <h2>V√≠nculos</h2>
                <p><strong>Associa√ß√£o:</strong> {{associado.associacao.nome_fantasia}}</p>
                <p><strong>Reparti√ß√£o:</strong> {{associado.reparticao.nome_reparticao}}</p>
                <p><strong>Delegado:</strong> {{associado.reparticao.delegado}}</p>
                <p><strong>Circunscri√ß√£o / Atua√ß√£o:</strong> {{associado.municipio_circunscricao}}</p>
                <p><strong>Data Filia√ß√£o:</strong> {{ associado.data_filiacao|date:"d/m/Y" }}</p>
            </div>
            <div>
                <h2>Contato</h2>
                <p><strong>Celular:</strong> {{associado.associacao.celular}}</p>
                <p><strong>Correspond√™ncia: </strong> {{associado.celular_correspondencia}}</p>
                <p><strong>Email</strong> {{associado.associacao.email}}</p>
                <p><strong>Senha Site: </strong> {{associado.senha_site}}</p>
                <p><strong>Senha Google: </strong> {{associado.senha_google}}</p>
            </div> 
            <div>
                <h2>Endere√ßo Residencial</h2>
                <p><strong>Logradouro:</strong> {{associado.logradouro}},
                    {{associado.numero}}, {{associado.complemento}}, {{associado.bairro}}</p>
                <p><strong>Municipio</strong> {{associado.municipio}}</p>
                <p><strong>UF</strong> {{associado.uf}}</p>
                <p><strong>CEP</strong> {{associado.cep}}</p>
            </div>  
            <div>
                <h2>Acesso</h2>
                <div class="copy-wrapper">
                    <p id="cpf-{{ associado.pk }}"><strong>CPF:</strong> {{ associado.cpf }}</p>
                    <button onclick="copyToClipboard('cpf-{{ associado.pk }}', this)" class="copy-btn" title="Copiar CPF">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>
                <div class="copy-wrapper">
                    <p id="senha_gov-{{ associado.pk }}"><strong>Senha Gov:</strong> {{ associado.senha_gov }}</p>
                    <button onclick="copySenhas('senha_gov-{{ associado.pk }}', this)" class="copy-btn" title="Copiar Senha Gov">
                        <i class="material-icons">content_copy</i>
                    </button>
                </div>

                <br><hr>
                {% if associado.drive_folder_id %}
                    <div class="drive-link">
                        <a href="https://drive.google.com/drive/folders/{{ associado.drive_folder_id }}" target="_blank">
                            <img src="https://www.gstatic.com/images/branding/product/2x/drive_2020q4_48dp.png"
                                alt="Google Drive" class="drive-icon"> 
                            <span> Acessar Pasta no Drive</span>
                        </a>
                        </div>
                        {% else %}
                        <div class="drive-link no-folder">
                        <span>Nenhuma pasta no Drive vinculada.</span>
                    </div>
                {% endif %}
            </div>

            <div>
                <h2>Aplica√ß√µes</h2>
                {% if status_ok %}
                    {% if deve_aplicar_anuidades %}
                        <form method="post" style="margin: 15px 0;">
                            {% csrf_token %}
                            <button type="submit" name="aplicar_anuidades" class="btn btn-primary">
                                Aplicar Anuidade(s) {{ anos_faltantes|join:", " }}
                            </button>
                        </form>
                    {% elif msg_anuidades_aplicadas %}
                        <div style="color:green;">
                            Todas as anuidades j√° foram aplicadas a este associado!
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        Este associado ainda n√£o est√° ativo/aposentado. Anuidades s√≥ podem ser aplicadas quando o status for v√°lido.
                    </div>
                {% endif %}

                <!-- BLOCO PARA INSS -->
                {% if associado.recolhe_inss == 'Sim' %}
                    {% if inss_aplicado %}
                        <div style="color:green;">
                            Todas as guias INSS j√° foram aplicadas a este associado!
                        </div>
                    {% else %}
                        <form method="post" style="margin: 15px 0;">
                            {% csrf_token %}
                            <button type="submit" name="aplicar_inss" class="btn btn-success">
                                Incluir em todas Guias INSS lan√ßadas
                            </button>
                        </form>
                    {% endif %}
                {% else %}
                    <div style="color:#888;">
                        Associado n√£o recolhe INSS.
                    </div>
                {% endif %}

                <!-- BLOCO PARA SEGURO DEFESO -->
                {% if associado.recebe_seguro == 'Recebe' %}
                    {% if not beneficio_defeso_ultimo %}
                        <div style="color:orange;">
                            N√£o h√° defeso lan√ßado para o estado onde este associado est√° vinculado.
                        </div>
                    {% elif defeso_aplicado %}
                        <div style="color:green;">
                            Seguro Defeso j√° foi aplicado para este associado!
                        </div>
                    {% else %}
                        <form method="post" style="margin: 15px 0;">
                            {% csrf_token %}
                            <button type="submit" name="aplicar_defeso" class="btn btn-info">
                                Incluir no √∫ltimo Seguro Defeso lan√ßado
                            </button>
                        </form>
                    {% endif %}
                {% else %}
                    <div style="color:#888;">
                        Associado n√£o √© eleg√≠vel ao Seguro Defeso.
                    </div>
                {% endif %}
          
            </div>  

            <div>
                <h2>Financeiro</h2>
                <a href="{% url 'app_anuidades:anuidade_associado_singular' associado.pk %}" class="upload-link">
                    üìÖ Ver anuidades e baixar/descontar
                </a>

                <div class="mini-tabela-anuidades">
                    <small>√öltimas Anuidades</small>
                    <table>
                        <thead>
                            <tr>
                                <th>Ano</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in ultimas_anuidades %}
                            <tr>
                                <td>{{ item.ano }}</td>
                                <td>
                                <span class="status-tag {% if item.status_pagamento == 'Paga' %}status-pago{% else %}status-pendente{% endif %}">
                                    {{ item.status_pagamento }}
                                </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="2">Sem dados dispon√≠veis.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>            
        </div>
    </div>

    <!--Dados Pessoais-->
    <div class="tab-content" id="tab-pessoais">
        <div class="detail-section multi-cols">
            <h2>Dados Pessoais</h2>
            {% include "components/associados/dados_pessoais.html" %}
        </div><br><hr>

        <!-- Produ√ß√£o Anual -->
        <div class="detail-section full-width">
            <h2>Produ√ß√£o Anual de Pesca</h2>
            <table class="tabela-producao">
                <thead>
                <tr>
                    <th>Esp√©cie</th>
                    <th>Quantidade (Kg)</th>
                    <th>Pre√ßo por Kg (R$)</th>
                </tr>
                </thead>
                <tbody>
                {% if associado.especie1 %}
                <tr>
                    <td>{{ associado.especie1 }}</td>
                    <td>{{ associado.quantidade1 }}</td>
                    <td>{{ associado.preco1|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie2 %}
                <tr>
                    <td>{{ associado.especie2 }}</td>
                    <td>{{ associado.quantidade2 }}</td>
                    <td>{{ associado.preco2|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie3 %}
                <tr>
                    <td>{{ associado.especie3 }}</td>
                    <td>{{ associado.quantidade3 }}</td>
                    <td>{{ associado.preco3|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie4 %}
                <tr>
                    <td>{{ associado.especie4 }}</td>
                    <td>{{ associado.quantidade4 }}</td>
                    <td>{{ associado.preco4|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if associado.especie5 %}
                <tr>
                    <td>{{ associado.especie5 }}</td>
                    <td>{{ associado.quantidade5 }}</td>
                    <td>{{ associado.preco5|floatformat:2 }}</td>
                </tr>
                {% endif %}
                </tbody>
            </table>
        </div><br><hr>
        <!-- Petrechos de Pesca -->
        <div class="detail-section four-cols">
            <h2 style="grid-column: 1 / -1;">Petrechos de Pesca</h2>
            {% for petrecho in associado.petrechos_pesca.all %}
                <div class="petrecho-box">{{ petrecho.nome }}</div>
            {% empty %}
                <p style="grid-column: 1 / -1;">Nenhum petrecho informado.</p>
            {% endfor %}
        </div>
    </div>

    <!--Documentos-->
    <div class="tab-content" id="tab-documentos">
        {% include "components/associados/copys.html" %}
    </div>

    <!--Uploads-->
    <div class="tab-content" id="tab-uploads">
        <div class="upload-links-row">
            <a href="{% url 'app_uploads:create_upload' %}?type=associado&id={{ associado.id }}" class="upload-link">
                üì§ Enviar Documento
            </a> 
             -- <a href="{% url 'app_uploads:create_tipo_doc' %}" class="upload-link">
                üìù Cadastrar Tipo de Documento
            </a>
             -- <a href="{% url 'app_uploads:list_tipo_docs' %}" class="upload-link">
                üìä Lista Tipos de Documentos
            </a>            
        </div>

        <div class="detail-section full-width">
            <h2>Uploads</h2>

            {% if uploads_docs %}
                <div class="lista-container">
                    <table class="table-list-small">
                        <thead>
                        <tr>
                            <th>Tipo de Documento</th>
                            <th>Extens√£o</th>
                            <th>Data de Envio</th>
                            <th>Enviado Por</th>
                            <th>A√ß√µes</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for doc in uploads_docs %}
                            <tr>
                            <td>{{ doc.tipo.nome|default:doc.tipo_custom }}</td>
                            <!--Extens√£o-->
                            <td>{{ doc.arquivo.name|slice:"-4:"|upper }}</td>
                            <td>{{ doc.data_envio|date:"d/m/Y H:i" }}</td>
                            <td>{{ doc.enviado_por.get_full_name|default:doc.enviado_por.username }}</td>

                            <td>
                                <a href="{{ doc.arquivo.url }}" download title="Download">
                                    <span class="material-icons icon-download">download</span>
                                </a>

                                {% with doc.ext|lower as ext %}


                                    {% if ext|is_in:"jpg jpeg png" %}
                                        <a href="{% url 'converter_para_pdf' doc.pk %}" title="Converter imagem em PDF">
                                            <span class="material-icons icon-convert">picture_as_pdf</span>
                                        </a>
                                    {% endif %}

                                    {% if ext != "pdf" %}
                                        <a href="{% url 'app_uploads:converter_para_pdf' doc.pk %}" title="Converter para PDF">
                                            <span class="material-icons icon-convert">picture_as_pdf</span>
                                        </a>
                                    {% endif %}
                                {% endwith %}

                                <a href="{{ doc.arquivo.url }}" target="_blank" title="Visualizar">
                                    <span class="material-icons icon-view">visibility</span>
                                </a>
                                {% if doc.proprietario_object.drive_folder_id %}
                                    <form method="post" action="{% url 'app_associados:enviar_para_drive' doc.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" title="Enviar para o Google Drive" style="background:none; border:none; padding:0; margin:0;">
                                            <span class="material-icons" style="color:rgb(128, 125, 250);">upload_file</span>
                                        </button>
                                    </form>
                                {% endif %}

                                <a href="#" class="btn-icon" title="Excluir Documento"
                                    onclick="openDeleteModal('{{ doc.pk }}')">
                                    <span class="material-icons icon-delete">delete</span>
                                </a>

                            </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
            <p>Nenhum documento enviado ainda.</p>
            {% endif %}
        </div> 
    </div>

    <!--Servi√ßos-->
    <div class="tab-content" id="tab-servicos">

        <a href="{% url 'app_servicos:create_servico' associado.pk %}?type=associado&id={{ associado.id }}" class="upload-link">
            üõ†Ô∏è  Novo Servi√ßo
        </a> 
             
       
        <div class="detail-section full-width">
            <h2>Servi√ßos</h2>
            {% if servicos %}
                <ul class="lista-servicos">
                    {% for servico in servicos %}
                        <li>
                            <a href="{% url 'app_servicos:single_servico' servico.pk %}">
                                {{ servico.get_natureza_servico_display }} /
                                {{ servico.get_tipo_servico_display }}<br>
                                <small>Status: {{ servico.status_servico|title }} | Valor: R$ {{ servico.valor|floatformat:2 }}</small>
                                <small style="color: #999;">- criado em {{ servico.data_inicio|date:'d/m/Y H:i' }}</small>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Nenhum servi√ßo vinculado</p>
            {% endif %}
        </div>

    </div>
    <!--Declara√ß√µes-->
    <div class="tab-content" id="tab-declaracoes">
        <div class="detail-section full-width">
        <h2>Declara√ß√µes - Automatizadas</h2>
        <p>Dec: 12</p>
        <p>Dec: 5</p>
        <p>Dec: 40 horas</p>
        </div>
    </div>    

  

    <!--Produ√ß√£o INSS e DEFESO-->
    <div class="tab-content" id="tab-producao">
        <div class="detail-section full-width">
        <h2>Guias INSS</h2>
        <table class="table table-sm" style="width: auto;">
            <thead>
                <tr>
                    <th>M√™s/Ano</th>
                    <th>Status Emiss√£o</th>
                    <th>Status Acesso</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                {% for guia in guias_inss %}
                    <tr>
                        <form method="post" style="display: contents;">
                            {% csrf_token %}
                            <input type="hidden" name="guia_id" value="{{ guia.id }}">
                            <td>{{ guia.get_mes_display }}/{{ guia.ano }}</td>
                            <td>
                                <div style="display: flex; gap: 6px; background: #f2faff; border-radius: 4px; padding: 4px 8px;">
                                {% for value, label in STATUS_EMISSAO_INSS %}
                                    <label style="font-weight: 400; margin: 0 3px 0 0;">
                                        <input type="radio" name="status_emissao" value="{{ value }}" {% if guia.status_emissao == value %}checked{% endif %}>
                                        {{ label }}
                                    </label>
                                {% endfor %}
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; gap: 6px; background: #f6f6f9; border-radius: 4px; padding: 4px 8px;">
                                {% for value, label in ACESSO_CHOICES %}
                                    <label style="font-weight: 400; margin: 0 3px 0 0;">
                                        <input type="radio" name="status_acesso" value="{{ value }}" {% if guia.status_acesso == value %}checked{% endif %}>
                                        {{ label }}
                                    </label>
                                {% endfor %}
                                </div>
                            </td>
                            <td>
                                <button type="submit" onclick="saveTabHash(this)">Salvar</button>

                            </td>
                        </form>
                    </tr>
                {% empty %}
                    <tr><td colspan="4">Nenhuma guia encontrada.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        </div>
        <div class="detail-section full-width">
            <h2>Seguro Defeso</h2>
            <p>Artigos publicados em 2024: 12</p>
            <p>Participa√ß√£o em eventos: 5</p>
            <p>Voluntariado: 40 horas</p>
        </div>        
    </div>

    <div class="tab-content" id="tab-anotacoes">
        <div class="detail-section full-width">
            <h3>Anota√ß√µes</h3>
            <form id="notas-form" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <textarea
                        name="content"
                        id="content-textarea"
                        rows="10"
                        style="width:100%; min-height:160px; resize:vertical; padding:10px; font-size:14px; font-family: inherit; background:white;"
                        oninput="autoGrow(this)"
                    >{{ associado.content|default_if_none:"" }}</textarea>


                </div>
                <button type="submit" id="btn-salvar-anotacao" class="btn btn-primary" style="margin-top:8px;">Salvar Anota√ß√µes</button>
                <span id="notas-msg" style="margin-left:15px;color:green;display:none;"></span>
            </form>
        </div>
    </div>

    <!--Modal -->
    <div id="deleteModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <h3>Excluir Documento?</h3>
            <p>Tem certeza que deseja remover este documento?</p>
            <div class="modal-actions">
            <button id="confirmDeleteBtn" class="btn btn-danger">Sim, excluir</button>
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    

{% block extra_js %}
    <script src="{% static 'js/tabs.js' %}"></script>
    <script src="{% static 'js/multiples_uploads.js' %}"></script>
    <script src="{% static 'js/delete_upload.js' %}"></script>
    <script src="{% static 'js/copy_to_clipboard.js' %}"></script>
    <script src="{% static 'js/copy_senhas.js' %}"></script>
    <script src="{% static 'js/content_associados.js' %}"></script>
    <script src="{% static 'js/config_content_associados.js' %}"></script>
{% endblock %}

{% endblock %}
