{% extends 'base.html' %}
{% load static %}

{% block title %}Lan√ßamentos INSS{% endblock title%}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/listas.css' %}">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/mensagens.css' %}">  
{% endblock %}

{% block content %}
    {% if request.user.is_superuser %}
        {% include "components/navbar_superuser.html" %}
    {% elif request.user.user_type == "admin_associacao" %}
        {% include "components/navbar_admin_associacao.html" %}
    {% elif request.user.user_type == "auxiliar_associacao" %}
        {% include "components/navbar_aux_associacao.html" %}
    {% else %}    
        {% include "components/navbar_home.html" %}
    {% endif %}


    <div class="lista-container-small">
        <h1>Lan√ßamentos INSS</h1>
        <p class="mensagem-suave">
            Nesta se√ß√£o, voc√™ pode visualizar, gerar e gerenciar os lan√ßamentos do INSS dos associados.  
            Selecione o <strong>ano</strong> e o <strong>m√™s</strong> desejados e clique em <em>Filtrar/Selecionar</em> para carregar os registros correspondentes.  
            Se n√£o houver registros para o per√≠odo que voc√™ filtrou/selacionou, voc√™ poder√° fazer o lan√ßamento utilizando o bot√£o <em>Gerar Guias INSS</em> para criar as guias referentes ao per√≠odo selecionado.  
            Caso prefira, √© poss√≠vel tamb√©m executar o processo manualmente ‚Äî ao clicar em <em>Processar Manualmente</em>, o sistema percorrer√° automaticamente todos os associados da lista correspondente.
        </p>


        <div id="toast-container">
            {% for message in messages %}
                {% with message.tags as tag %}
                    <div class="toast 
                        {% if 'success' in tag %}toast-success{% elif 'error' in tag or 'danger' in tag %}toast-error
                        {% elif 'info' in tag %}toast-info
                        {% elif 'warning' in tag %}toast-warning
                        {% else %}toast-info{% endif %}">
                        <span>{{ message }}</span>
                        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>

        <div class="botoes-inss-container" style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px;">
            <div style="flex: 1;">
                <form method="post" id="form-gerar-guias">
                    {% csrf_token %}
                    <input type="hidden" name="ano" value="{{ ano_selecionado }}">
                    <input type="hidden" name="mes" value="{{ mes_selecionado }}">
                    <p class="descricao-secundaria">Selecione ano/m√™s e filtre, depois clique aqui para gerar guias.</p>
                    <button type="button" id="btn-gerar-guias"
                            class="btn btn-primary"
                            {% if not ano_selecionado or not mes_selecionado %}disabled{% endif %}>
                        üìÑ Gerar Guias INSS
                    </button>
                </form>
                <!-- Modal dentro do btn-left, se quiser que fique relacionado ao bot√£o esquerdo -->
                <div id="modal_confirm" class="modal-overlay" style="display:none;">
                    <div class="modal">
                        <h2 id="modal-confirm-title">Confirma√ß√£o</h2>
                        <p id="modal-confirm-message">Deseja realizar esta a√ß√£o?</p>
                        <div class="modal-actions">
                            <button type="button" class="btn-sim" id="btn-modal-sim">Sim</button>
                            <button type="button" class="btn-nao" id="btn-modal-nao">N√£o</button>
                        </div>
                    </div>
                </div>                
            </div>

            <div style="flex: 1;">
                <form method="get" action="{% url 'app_inss:processamento_inss_do_mes' %}">
                    <input type="hidden" name="ano" value="{{ ano_selecionado }}">
                    <input type="hidden" name="mes" value="{{ mes_selecionado }}">
                    <button type="submit" class="btn btn-secondary">
                        ‚öôÔ∏è Processar Manualmente
                    </button>
                </form>
            </div>

            {% if not tem_processamento %}
            <div style="flex: 1;">
                <form method="post" action="{% url 'app_inss:resetar_processamento' %}?ano={{ ano_selecionado }}&mes={{ mes_selecionado }}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        üîÅ Resetar Processamento
                    </button>
                </form>
            </div>
            {% endif %}
        </div>

        <div class="filtros-inss">
            <form method="get" class="form-group">
                <div class="form-grid grid-3-cols">
                    <div class="form-group">
                        <label for="id_ano">Ano:</label>
                        <select name="ano" id="id_ano" required>
                            {% for ano in anos %}
                                <option value="{{ ano }}" {% if ano|stringformat:"s" == ano_selecionado|stringformat:"s" %}selected{% endif %}>{{ ano }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_mes">M√™s:</label>
                        <select name="mes" id="id_mes" required>
                            {% for m in meses %}
                                <option value="{{ m.0 }}" {% if m.0|stringformat:"s" == mes_selecionado|stringformat:"s" %}selected{% endif %}>{{ m.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" style="align-self: end;">
                        <button type="submit" class="btn btn-primary">Filtrar/Selecionar</button>
                    </div>
                </div>
            </form>
        </div>

        <div style="margin-top: 16px; margin-bottom: 12px;">
            <p><strong>Refer√™ncia:</strong> {{ mes_selecionado }}/{{ ano_selecionado }}</p>
            <p><strong>Guias lan√ßadas:</strong> {{ guias|length }}</p>
        </div>

        <table class="table-list-small">
            <thead>
                <tr>
                    <th>Associado</th>
                    <th>M√™s/Ano</th>
                    <th>Emiss√£o</th>
                    <th>Acesso</th>
                </tr>
            </thead>
            <tbody>
                {% for guia in guias %}
                <tr>
                    <td>{{ guia.associado.user.get_full_name }}</td>
                    <td>{{ guia.get_mes_display }}/{{ guia.ano }}</td>
                    <td>{{ guia.get_status_emissao_display }}</td>
                    <td>{{ guia.get_status_acesso_display }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4">Nenhuma guia encontrada para este per√≠odo.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% block extra_js %}
    <script src="{% static 'js/modal_confirm_guias.js' %}"></script>
{% endblock %}

{% endblock %}