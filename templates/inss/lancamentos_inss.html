{% extends 'base.html' %}
{% load static %}

{% block title %}Lan√ßamentos INSS{% endblock title%}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/listas.css' %}">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/mensagens.css' %}">  
{% endblock %}

{% block content %}
{% include 'components/navbar_superuser.html' %}


<div class="lista-container-small">
    <h1>Lan√ßamentos INSS</h1>

    <div id="toast-container">
        {% for message in messages %}
            {% with message.tags as tag %}
                <div class="toast 
                    {% if 'success' in tag %}toast-success{% elif 'error' in tag or 'danger' in tag %}toast-error
                    {% elif 'info' in tag %}toast-info
                    {% elif 'warning' in tag %}toast-warning
                    {% else %}toast-info{% endif %}">
                    <span>{{ message }}</span>
                    <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                </div>
            {% endwith %}
        {% endfor %}
    </div>

    <div class="botoes-inss-container">
        <div class="btn-left">
            <form method="post" id="form-gerar-guias">
                {% csrf_token %}
                <input type="hidden" name="ano" value="{{ ano_selecionado }}">
                <input type="hidden" name="mes" value="{{ mes_selecionado }}">
                <p>Voc√™ pode gerar e distribuir as guias do INSS a partir do dia 1 de cada m√™s. Por padr√£o, os campos select vir√£o com ano e m√™s atual.</p>
                <button type="button" id="btn-gerar-guias"
                    {% if not ano_selecionado or not mes_selecionado %}disabled{% endif %}>
                    üìÑ Gerar Guias INSS do M√™s
                </button>
            </form>
            <!-- Modal dentro do btn-left, se quiser que fique relacionado ao bot√£o esquerdo -->
            <div id="modal_confirm" class="modal-overlay" style="display:none;">
                <div class="modal">
                    <h2 id="modal-confirm-title">Confirma√ß√£o</h2>
                    <p id="modal-confirm-message">Deseja realizar esta a√ß√£o?</p>
                    <div class="modal-actions">
                        <button type="button" class="btn-sim" id="btn-modal-sim">Sim</button>
                        <button type="button" class="btn-nao" id="btn-modal-nao">N√£o</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="btn-right">
            <form method="get" action="{% url 'app_inss:processamento_inss_do_mes' %}">
                <input type="hidden" name="ano" value="{{ ano_selecionado }}">
                <input type="hidden" name="mes" value="{{ mes_selecionado }}">
                <button type="submit" class="btn btn-primary">
                    ‚öôÔ∏è Iniciar Processamento Manual INSS
                </button>
            </form> 
        </div>
    </div>

    {% if not tem_processamento %}
        <div class="btn-right">
            <form method="post" action="{% url 'app_inss:resetar_processamento' %}?ano={{ ano_selecionado }}&mes={{ mes_selecionado }}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">
                ‚ùóResetar Processamento
                </button>
            </form>
        </div>
    {% endif %}

    <div style="margin-bottom:24px;">
        <form method="get" class="form-group" style="grid-column: span 4;">
            <div class="form-grid grid-3-cols">
                <div class="form-group">
                    <label for="id_ano">Ano:
                        <select name="ano" id="id_ano" required>
                            {% for ano in anos %}
                                <option value="{{ ano }}" {% if ano|stringformat:"s" == ano_selecionado|stringformat:"s" %}selected{% endif %}>{{ ano }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>
                <div class="form-group">
                    <label for="id_mes">M√™s:
                        <select name="mes" id="id_mes" required>
                            {% for m in meses %}
                                <option value="{{ m.0 }}" {% if m.0|stringformat:"s" == mes_selecionado|stringformat:"s" %}selected{% endif %}>{{ m.1 }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>
                <div class="form-group" style="align-self: end;">
                    <button type="submit">Filtrar</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Lista de Guias Criadas -->
    <table class="table-list-small">
        <thead>
            <tr>
                <th>Associado</th>
                <th>M√™s/Ano</th>
                <th>Emiss√£o</th>
                <th>Acesso</th>
            </tr>
        </thead>
        <tbody>
            {% for guia in guias %}
            <tr>
                <td>{{ guia.associado.user.get_full_name }}</td>
                <td>{{ guia.get_mes_display }}/{{ guia.ano }}</td>
                <td>{{ guia.get_status_emissao_display }}</td>
                <td>{{ guia.get_status_acesso_display }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="8">Nenhuma guia encontrada para este m√™s/ano.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% block extra_js %}
    <script src="{% static 'js/modal_confirm_guias.js' %}"></script>
{% endblock %}

{% endblock %}