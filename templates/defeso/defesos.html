{% extends 'base.html' %}
{% load static %}

{% block title %}Lan√ßamentos Seguro Defeso{% endblock title%}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/listas.css' %}">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/mensagens.css' %}">  
{% endblock %}

{% block content %}
{% include 'components/navbar_superuser.html' %}

<div class="lista-container">

    <h1>Lan√ßamentos: Seguro Defeso</h1>

    <div id="toast-container">
        {% for message in messages %}
            {% with message.tags as tag %}
                <div class="toast 
                    {% if 'success' in tag %}toast-success{% elif 'error' in tag or 'danger' in tag %}toast-error
                    {% elif 'info' in tag %}toast-info
                    {% elif 'warning' in tag %}toast-warning
                    {% else %}toast-info{% endif %}">
                    <span>{{ message }}</span>
                    <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                </div>
            {% endwith %}
        {% endfor %}
    </div>

    <p>Total benef√≠cios lan√ßados: {{ beneficios|length }}</p>

    <form method="get" class="form-group">
        <label>Selecione o benef√≠cio:</label>
        <select name="beneficio" onchange="this.form.submit()">
            <option value="">--- Selecione ---</option>
            {% for b in beneficios %}
                <option value="{{ b.id }}" {% if b.id|stringformat:"s" == beneficio_id %}selected{% endif %}>
                    {{ b.especie_alvo }} ({{ b.data_inicio|date:'d/m/Y' }} - {{ b.data_fim|date:'d/m/Y' }}) - {{ b.estado }}
                </option>
            {% endfor %}
        </select>
    </form>

    {% if associados_beneficiados %}
        <h2>Associados beneficiados</h2>
        <!-- S√ì MOSTRA O BOT√ÉO SE H√Å BENEF√çCIO SELECIONADO E ASSOCIADOS -->
    {% if beneficio and beneficio.id %}
        {% if mostrar_iniciar %}
            <form method="get" action="{% url 'app_defeso:proximo_controle_para_processar' %}">
                <input type="hidden" name="beneficio_id" value="{{ beneficio.id }}">
                <button type="submit" class="btn btn-primary">
                    ‚öôÔ∏è Iniciar Processamento Manual Defeso
                </button>
            </form>
        {% endif %}

        {% if mostrar_reset %}
            <form method="post" action="{% url 'app_defeso:resetar_rodada_processamento' %}" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="beneficio_id" value="{{ beneficio.id }}">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Deseja realmente resetar a √∫ltima rodada?');">
                    üîÅ Resetar √öltima Rodada de Processamento
                </button>
            </form>
        {% endif %}
    {% endif %}


      
        <table class="table-list-small">
            <tr>
                <th style="text-align: left;">Nome</th>
                <th style="text-align: left;">CPF</th>
                <th style="text-align: left;">Munic√≠pio</th>
                <th style="text-align: left;">UF</th>
                <th style="text-align: left;">Status Pedido</th>
                <th style="text-align: left;">Ano Concess√£o</th>
            </tr>
            {% for c in associados_beneficiados %}
                <tr>
                    <td>
                        <a href="{% url 'app_defeso:controle_beneficio_edit' c.pk %}" class="nome-link">
                            {{ c.associado.user.get_full_name }}
                        </a>
                    </td>
                    <td>{{ c.associado.cpf }}</td>
                    <td>{{ c.associado.municipio_circunscricao }}</td>
                    <td>{{ c.associado.municipio_circunscricao.uf }}</td>
                    <td>{{ c.get_status_pedido_display }}</td>
                    <td>{{ c.beneficio.ano_concessao }}</td>
                </tr>
            {% endfor %}
        </table>

    {% elif beneficio_id %}
        <div style="margin-top: 12px; color: #b22222;">Nenhum associado encontrado para esse benef√≠cio.</div>
    {% endif %}





    </div>
</div>



{% endblock %}